

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>lib.cuckoo.common.abstracts &mdash; Bold-Falcon 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Bold-Falcon
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">agent:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../agent.html">agent package</a></li>
</ul>
<p class="caption"><span class="caption-text">analyzer:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzer.html">analyzer package</a></li>
</ul>
<p class="caption"><span class="caption-text">auxiliary:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../auxiliary.html">auxiliary package</a></li>
</ul>
<p class="caption"><span class="caption-text">processing:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../processing.html">processing package</a></li>
</ul>
<p class="caption"><span class="caption-text">signatures:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../signatures.html">signatures package</a></li>
</ul>
<p class="caption"><span class="caption-text">report</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reporting.html">reporting package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Bold-Falcon</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>lib.cuckoo.common.abstracts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lib.cuckoo.common.abstracts</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding=utf-8</span>
<span class="c1"># Copyright (C) 2010-2013 Claudio Guarnieri.</span>
<span class="c1"># Copyright (C) 2014-2018 Cuckoo Foundation.</span>
<span class="c1"># Copyright (C) 2020-2021 PowerLZY.</span>
<span class="c1"># This file is part of Cuckoo Sandbox - http://www.cuckoosandbox.org</span>
<span class="c1"># See the file &#39;docs/LICENSE&#39; for copying permission.</span>



<div class="viewcode-block" id="Auxiliary"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Auxiliary">[docs]</a><span class="k">class</span> <span class="nc">Auxiliary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base abstract class for auxiliary modules.</span>
<span class="sd">    </span>
<span class="sd">    :param task: Current analysis task</span>
<span class="sd">    :param machine: machine info</span>
<span class="sd">    :param options: options conf </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Auxiliary.set_task"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Auxiliary.set_task">[docs]</a>    <span class="k">def</span> <span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        set Current analysis task info</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Auxiliary.set_machine"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Auxiliary.set_machine">[docs]</a>    <span class="k">def</span> <span class="nf">set_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        set machine info</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span></div>

<div class="viewcode-block" id="Auxiliary.set_options"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Auxiliary.set_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        set options</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Auxiliary.start"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Auxiliary.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        start machine</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Auxiliary.stop"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Auxiliary.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        stop machine</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="Machinery"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery">[docs]</a><span class="k">class</span> <span class="nc">Machinery</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base abstract class for machinery modules.</span>

<span class="sd">    :note: Default label used in machinery configuration file to supply virtual machine name/label/vmx path. Override it if you dubbed it in another way.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LABEL</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_globals</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="c1"># Database pointer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>

        <span class="c1"># Machine table is cleaned to be filled from configuration file</span>
        <span class="c1"># at each start.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clean_machines</span><span class="p">()</span>

<div class="viewcode-block" id="Machinery.pcap_path"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.pcap_path">[docs]</a>    <span class="k">def</span> <span class="nf">pcap_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the .pcap path for this task id.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUCKOO_ROOT</span><span class="p">,</span> <span class="s2">&quot;storage&quot;</span><span class="p">,</span> <span class="s2">&quot;analyses&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">,</span> <span class="s2">&quot;dump.pcap&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machinery.set_options"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.set_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set machine manager options.</span>
<span class="sd">        </span>
<span class="sd">        :param options: machine manager options dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Machinery.initialize"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read, load, and verify machines configuration.</span>
<span class="sd">        </span>
<span class="sd">        :param module_name: module name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="c1"># Run initialization checks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_check</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_resultserver_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the ResultServer port.</span>
<span class="sd">        </span>
<span class="sd">        :note: Avoid import recursion issues by importing ResultServer here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lib.cuckoo.core.resultserver</span> <span class="kn">import</span> <span class="n">ResultServer</span>
        <span class="k">return</span> <span class="n">ResultServer</span><span class="p">()</span><span class="o">.</span><span class="n">port</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read configuration.</span>
<span class="sd">        </span>
<span class="sd">        :param module_name: module name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span> <span class="o">=</span> <span class="n">module_name</span>
        <span class="n">mmanager_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">machine_id</span> <span class="ow">in</span> <span class="n">mmanager_opts</span><span class="p">[</span><span class="s2">&quot;machines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">machine_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">machine_id</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">machine</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">machine_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">)</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span>

                <span class="c1"># If configured, use specific network interface for this</span>
                <span class="c1"># machine, else use the default value.</span>
                <span class="k">if</span> <span class="n">machine_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interface&quot;</span><span class="p">):</span>
                    <span class="n">machine</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">machine</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">mmanager_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interface&quot;</span><span class="p">)</span>

                <span class="c1"># If configured, use specific snapshot name, else leave it</span>
                <span class="c1"># empty and use default behaviour.</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;snapshot&quot;</span><span class="p">)</span>

                <span class="c1"># If configured, use specific resultserver IP and port,</span>
                <span class="c1"># else use the default value.</span>
                <span class="n">opt_resultserver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_globals</span><span class="o">.</span><span class="n">resultserver</span>

                <span class="c1"># the resultserver port might have been dynamically changed</span>
                <span class="c1">#  -&gt; get the current one from the resultserver singleton</span>
                <span class="n">opt_resultserver</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resultserver_port</span><span class="p">()</span>

                <span class="n">ip</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resultserver_ip&quot;</span><span class="p">,</span> <span class="n">opt_resultserver</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">machine_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resultserver_port&quot;</span><span class="p">,</span> <span class="n">opt_resultserver</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

                <span class="n">machine</span><span class="o">.</span><span class="n">resultserver_ip</span> <span class="o">=</span> <span class="n">ip</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">resultserver_port</span> <span class="o">=</span> <span class="n">port</span>

                <span class="c1"># Strip parameters.</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">machine</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">machine</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add_machine</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                    <span class="n">ip</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                                    <span class="n">platform</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
                                    <span class="n">options</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                    <span class="n">tags</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
                                    <span class="n">interface</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span>
                                    <span class="n">snapshot</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">snapshot</span><span class="p">,</span>
                                    <span class="n">resultserver_ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                                    <span class="n">resultserver_port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">CuckooOperationalError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Configuration details about machine </span><span class="si">%s</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;are missing: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">machine_id</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">def</span> <span class="nf">_initialize_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs checks against virtualization software when a machine manageris initialized.</span>
<span class="sd">        </span>
<span class="sd">        :note: in machine manager modules you may override or superclass his method.</span>
<span class="sd">        :raise CuckooMachineError: if a misconfiguration or a unkown vm state is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">configured_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">():</span>
            <span class="c1"># If this machine is already in the &quot;correct&quot; state, then we</span>
            <span class="c1"># go on to the next machine.</span>
            <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">configured_vms</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">POWEROFF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABORTED</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># This machine is currently not in its correct state, we&#39;re going</span>
            <span class="c1"># to try to shut it down. If that works, then the machine is fine.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CuckooMachineError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please update your configuration. Unable to shut &quot;</span> \
                      <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; down or find the machine in its proper state:&quot;</span> \
                      <span class="s2">&quot; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CuckooCriticalError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_globals</span><span class="o">.</span><span class="n">timeouts</span><span class="o">.</span><span class="n">vm_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooCriticalError</span><span class="p">(</span><span class="s2">&quot;Virtual machine state change timeout &quot;</span>
                                      <span class="s2">&quot;setting not found, please add it to &quot;</span>
                                      <span class="s2">&quot;the config file.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Machinery.machines"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.machines">[docs]</a>    <span class="k">def</span> <span class="nf">machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List virtual machines.</span>
<span class="sd">        </span>
<span class="sd">        :return: virtual machines list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_machines</span><span class="p">()</span></div>

<div class="viewcode-block" id="Machinery.availables"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.availables">[docs]</a>    <span class="k">def</span> <span class="nf">availables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        How many machines are free.</span>
<span class="sd">        </span>
<span class="sd">        :return: free machines count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">count_machines_available</span><span class="p">()</span></div>

<div class="viewcode-block" id="Machinery.acquire"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.acquire">[docs]</a>    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acquire a machine to start analysis.</span>
<span class="sd">        </span>
<span class="sd">        :param machine_id: machine ID.</span>
<span class="sd">        :param platform: machine platform.</span>
<span class="sd">        :param tags: machine tags</span>
<span class="sd">        :return: machine or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">machine_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">lock_machine</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">machine_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">platform</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">lock_machine</span><span class="p">(</span><span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">lock_machine</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machinery.release"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release a machine.</span>
<span class="sd">        </span>
<span class="sd">        :param label: machine name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unlock_machine</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machinery.running"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.running">[docs]</a>    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns running virtual machines.</span>
<span class="sd">        </span>
<span class="sd">        :return: running virtual machines list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_machines</span><span class="p">(</span><span class="n">locked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machinery.shutdown"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shutdown the machine manager. Kills all alive machines.</span>
<span class="sd">        </span>
<span class="sd">        :raise CuckooMachineError: if unable to stop machine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Still </span><span class="si">%s</span><span class="s2"> guests alive. Shutting down...&quot;</span><span class="p">,</span>
                     <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">CuckooMachineError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to shutdown machine </span><span class="si">%s</span><span class="s2">, please check &quot;</span>
                                <span class="s2">&quot;manually. Error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machinery.set_status"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set status for a virtual machine.</span>
<span class="sd">        </span>
<span class="sd">        :param label: virtual machine label</span>
<span class="sd">        :param status: new virtual machine status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set_machine_status</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machinery.start"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a machine.</span>
<span class="sd">        </span>
<span class="sd">        :param label: machine name.</span>
<span class="sd">        :param task: task object.</span>
<span class="sd">        :raise NotImplementedError: this method is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Machinery.stop"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a machine.</span>
<span class="sd">        </span>
<span class="sd">        :param label: machine name.</span>
<span class="sd">        :raise NotImplementedError: this method is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists virtual machines configured.</span>
<span class="sd">        </span>
<span class="sd">        :raise NotImplementedError: this method is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="Machinery.dump_memory"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Machinery.dump_memory">[docs]</a>    <span class="k">def</span> <span class="nf">dump_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a memory dump of a machine.</span>
<span class="sd">        </span>
<span class="sd">        :param path: path to where to store the memory dump.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">_wait_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for a vm status.</span>
<span class="sd">        </span>
<span class="sd">        :param label: virtual machine name.</span>
<span class="sd">        :param state: virtual machine status, accepts multiple states as list.</span>
<span class="sd">        :raise CuckooMachineError: if default waiting timeout expire.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This block was originally suggested by Loic Jaquemet.</span>
        <span class="n">waitme</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">current</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span> <span class="c1"># 虚拟机状态为poweroff {wrong}</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting </span><span class="si">%i</span><span class="s2"> cuckooseconds for machine </span><span class="si">%s</span><span class="s2"> to switch &quot;</span>
                      <span class="s2">&quot;to status </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">waitme</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">waitme</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options_globals</span><span class="o">.</span><span class="n">timeouts</span><span class="o">.</span><span class="n">vm_state</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Timeout hit while for machine </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                                         <span class="s2">&quot;to change status&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">waitme</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibVirtMachinery"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.LibVirtMachinery">[docs]</a><span class="k">class</span> <span class="nc">LibVirtMachinery</span><span class="p">(</span><span class="n">Machinery</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Libvirt based machine manager.</span>

<span class="sd">    :note: If you want to write a custom module for a virtualization software</span>
<span class="sd">    supported by libvirt you have just to inherit this machine manager and</span>
<span class="sd">    change the connection string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># VM states.</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="n">PAUSED</span> <span class="o">=</span> <span class="s2">&quot;paused&quot;</span>
    <span class="n">POWEROFF</span> <span class="o">=</span> <span class="s2">&quot;poweroff&quot;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&quot;machete&quot;</span>
    <span class="n">ABORTED</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_LIBVIRT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooDependencyError</span><span class="p">(</span><span class="s2">&quot;Unable to import libvirt&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LibVirtMachinery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="LibVirtMachinery.initialize"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.LibVirtMachinery.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize machine manager module. Override default to set proper</span>
<span class="sd">        connection string.</span>
<span class="sd">        </span>
<span class="sd">        :param module:  machine manager module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LibVirtMachinery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">module</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_initialize_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs all checks when a machine manager is initialized.</span>
<span class="sd">        </span>
<span class="sd">        :raise CuckooMachineError: if libvirt version is not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Version checks.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version_check</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Libvirt version is not supported, &quot;</span>
                                     <span class="s2">&quot;please get an updated version&quot;</span><span class="p">)</span>

        <span class="c1"># Preload VMs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_machines</span><span class="p">()</span>

        <span class="c1"># Base checks. Also attempts to shutdown any machines which are</span>
        <span class="c1"># currently still active.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LibVirtMachinery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_initialize_check</span><span class="p">()</span>

<div class="viewcode-block" id="LibVirtMachinery.start"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.LibVirtMachinery.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a virtual machine.</span>
<span class="sd">        </span>
<span class="sd">        :param label: virtual machine name.</span>
<span class="sd">        :param task: task object.</span>
<span class="sd">        :raise CuckooMachineError: if unable to start virtual machine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting machine </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POWEROFF</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Trying to start a virtual machine that has not &quot;</span> \
                  <span class="s2">&quot;been turned off </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>

        <span class="n">vm_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">view_machine_by_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="n">snapshot_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">snapshotListNames</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># If a snapshot is configured try to use it.</span>
        <span class="k">if</span> <span class="n">vm_info</span><span class="o">.</span><span class="n">snapshot</span> <span class="ow">and</span> <span class="n">vm_info</span><span class="o">.</span><span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshot_list</span><span class="p">:</span>
            <span class="c1"># Revert to desired snapshot, if it exists.</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using snapshot </span><span class="si">{0}</span><span class="s2"> for virtual machine &quot;</span>
                      <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vm_info</span><span class="o">.</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">snapshot</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">snapshotLookupByName</span><span class="p">(</span><span class="n">vm_info</span><span class="o">.</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">revertToSnapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unable to restore snapshot </span><span class="si">{0}</span><span class="s2"> on &quot;</span> \
                      <span class="s2">&quot;virtual machine </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vm_info</span><span class="o">.</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_snapshot</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_snapshot</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using snapshot </span><span class="si">{0}</span><span class="s2"> for virtual machine &quot;</span>
                      <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">label</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">revertToSnapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Unable to restore snapshot on &quot;</span>
                                         <span class="s2">&quot;virtual machine </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;No snapshot found for virtual machine &quot;</span>
                                     <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

        <span class="c1"># Check state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_status</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibVirtMachinery.stop"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.LibVirtMachinery.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops a virtual machine. Kill them all.</span>
<span class="sd">        </span>
<span class="sd">        :param label: virtual machine name.</span>
<span class="sd">        :raise CuckooMachineError: if unable to stop virtual machine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping machine </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">POWEROFF</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Trying to stop an already stopped &quot;</span>
                                     <span class="s2">&quot;machine </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

        <span class="c1"># Force virtual machine shutdown.</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trying to stop an already stopped machine </span><span class="si">%s</span><span class="s2">. &quot;</span>
                          <span class="s2">&quot;Skip&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>  <span class="c1"># Machete&#39;s way!</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Error stopping virtual machine &quot;</span>
                                     <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="c1"># Check state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_status</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">POWEROFF</span><span class="p">)</span></div>

<div class="viewcode-block" id="LibVirtMachinery.shutdown"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.LibVirtMachinery.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override shutdown to free libvirt handlers - they print errors.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LibVirtMachinery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="c1"># Free handlers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vms</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LibVirtMachinery.dump_memory"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.LibVirtMachinery.dump_memory">[docs]</a>    <span class="k">def</span> <span class="nf">dump_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a memory dump.</span>
<span class="sd">        </span>
<span class="sd">        :param path: path to where to store the memory dump.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dumping memory for machine </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Resolve permission issue as libvirt creates the file as</span>
            <span class="c1"># root/root in mode 0600, preventing us from reading it. This</span>
            <span class="c1"># supposedly still doesn&#39;t allow us to remove it, though..</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">coreDump</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">libvirt</span><span class="o">.</span><span class="n">VIR_DUMP_MEMORY_ONLY</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Error dumping memory virtual machine &quot;</span>
                                     <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets current status of a vm.</span>
<span class="sd">        </span>
<span class="sd">        :param label: virtual machine name.</span>
<span class="sd">        :return: status string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting status for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

        <span class="c1"># Stetes mapping of python-libvirt.</span>
        <span class="c1"># virDomainState</span>
        <span class="c1"># VIR_DOMAIN_NOSTATE = 0</span>
        <span class="c1"># VIR_DOMAIN_RUNNING = 1</span>
        <span class="c1"># VIR_DOMAIN_BLOCKED = 2</span>
        <span class="c1"># VIR_DOMAIN_PAUSED = 3</span>
        <span class="c1"># VIR_DOMAIN_SHUTDOWN = 4</span>
        <span class="c1"># VIR_DOMAIN_SHUTOFF = 5</span>
        <span class="c1"># VIR_DOMAIN_CRASHED = 6</span>
        <span class="c1"># VIR_DOMAIN_PMSUSPENDED = 7</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Error getting status for virtual &quot;</span>
                                     <span class="s2">&quot;machine </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RUNNING</span>
            <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAUSED</span>
            <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POWEROFF</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR</span>

        <span class="c1"># Report back status.</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">status</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Unable to get status for &quot;</span>
                                     <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects to libvirt subsystem.</span>
<span class="sd">        </span>
<span class="sd">        :raise CuckooMachineError: when unable to connect to libvirt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if a connection string is available.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;You must provide a proper &quot;</span>
                                     <span class="s2">&quot;connection string&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Cannot connect to libvirt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnects to libvirt subsystem.</span>
<span class="sd">        </span>
<span class="sd">        :raise CuckooMachineError: if cannot disconnect from libvirt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Cannot disconnect from libvirt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetch_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch machines handlers.</span>
<span class="sd">        </span>
<span class="sd">        :return: dict with machine label as key and handle as value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">():</span>
            <span class="n">vms</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vms</span>

    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for a virtual machine.</span>
<span class="sd">        </span>
<span class="sd">        :param conn: libvirt connection handle.</span>
<span class="sd">        :param label: virtual machine name.</span>
<span class="sd">        :raise CuckooMachineError: if virtual machine is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">lookupByName</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Cannot find machine &quot;</span>
                                         <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vm</span>

    <span class="k">def</span> <span class="nf">_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List available virtual machines.</span>
<span class="sd">        </span>
<span class="sd">        :raise CuckooMachineError: if unable to list virtual machines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">listDefinedDomains</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Cannot list domains&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="k">def</span> <span class="nf">_version_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if libvirt release supports snapshots.</span>
<span class="sd">        </span>
<span class="sd">        :return: True or false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">8000</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current snapshot for virtual machine</span>
<span class="sd">        </span>
<span class="sd">        :param label: virtual machine name</span>
<span class="sd">        :return None or current snapshot</span>
<span class="sd">        :raise CuckooMachineError: if cannot find current snapshot or</span>
<span class="sd">                                   when there are too many snapshots available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_extract_creation_time</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Extracts creation time from a KVM vm config file.</span>
<span class="sd">            :param node: config file node</span>
<span class="sd">            :return: extracted creation time</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getXMLDesc</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">xml</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;./creationTime&quot;</span><span class="p">)</span>

        <span class="n">snapshot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vms</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="c1"># Try to get the currrent snapshot, otherwise fallback on the latest</span>
            <span class="c1"># from config file.</span>
            <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">hasCurrentSnapshot</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">snapshot</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">snapshotCurrent</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No current snapshot, using latest snapshot&quot;</span><span class="p">)</span>

                <span class="c1"># No current snapshot, try to get the last one from config file.</span>
                <span class="n">snapshot</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">listAllSnapshots</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                  <span class="n">key</span><span class="o">=</span><span class="n">_extract_creation_time</span><span class="p">,</span>
                                  <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">libvirt</span><span class="o">.</span><span class="n">libvirtError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooMachineError</span><span class="p">(</span><span class="s2">&quot;Unable to get snapshot for &quot;</span>
                                     <span class="s2">&quot;virtual machine </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">snapshot</span></div>

<div class="viewcode-block" id="Processing"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing">[docs]</a><span class="k">class</span> <span class="nc">Processing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base abstract class for processing module.&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Processing.set_options"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing.set_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set report options.</span>
<span class="sd">        </span>
<span class="sd">        :param options: report options dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Processing.set_task"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing.set_task">[docs]</a>    <span class="k">def</span> <span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add task information.</span>
<span class="sd">        </span>
<span class="sd">        :param task: task dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Processing.set_baseline"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing.set_baseline">[docs]</a>    <span class="k">def</span> <span class="nf">set_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the path to the baseline directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_path</span> <span class="o">=</span> <span class="n">baseline_path</span></div>

<div class="viewcode-block" id="Processing.set_path"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing.set_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set paths.</span>
<span class="sd">        </span>
<span class="sd">        :param analysis_path: analysis folder </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">analysis_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;analysis.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span>
                                                       <span class="s2">&quot;binary&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropped_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropped_meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;files.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;package_files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shots_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;shots&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pcap_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;dump.pcap&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmemory_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;memory.dmp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mitmout_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;mitm.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mitmerr_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;mitm.err&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlsmaster_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;tlsmaster.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suricata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;suricata&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskinfo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;task.json&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Processing.set_results"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing.set_results">[docs]</a>    <span class="k">def</span> <span class="nf">set_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the results - the fat dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Processing.run"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Processing.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start processing.</span>
<span class="sd">        </span>
<span class="sd">        :raise NotImplementedError: this method is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="Instance"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance">[docs]</a><span class="k">class</span> <span class="nc">Instance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instance for binaries .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LABEL_SIGNIFICANCE_COUNT</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">POSITIVE_RATE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">LABEL_SIGNIFICANCE_COUNT</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positives</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_features</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Instance.load_json"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.load_json">[docs]</a>    <span class="k">def</span> <span class="nf">load_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load JSON formatted malware report. It can handle both a path to JSON file and a dictionary object.</span>
<span class="sd">        </span>
<span class="sd">        :param json_file: json path</span>
<span class="sd">        :param name: default &quot;unknown&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">json_path</span> <span class="o">=</span> <span class="n">json_file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">malware_report</span><span class="p">:</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">malware_report</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">json_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown binary format</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Could not load the data *&quot;</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="s2">&quot;* is of &quot;</span> \
                <span class="s2">&quot;unknown type: &quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">json</span><span class="p">),</span> <span class="s2">&quot;.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># Get total and positives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;virustotal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;virustotal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;positives&quot;</span><span class="p">)</span>
        <span class="c1"># Pull all VT normalised results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;virustotal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scans&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.load_binaries"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.load_binaries">[docs]</a>    <span class="k">def</span> <span class="nf">load_binaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">first_n_byte</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Import the sample and convert it into a fixed length byte sequence for MalConv</span>

<span class="sd">        :param data_path: Analysis sample path</span>
<span class="sd">        :param first_n_byte: fixed length</span>
<span class="sd">        :return numpy: byte sequence</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()[:</span><span class="n">first_n_byte</span><span class="p">]]</span>  <span class="c1"># index 0 will be special padding index 每个值加一</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">first_n_byte</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooOperationalError</span><span class="p">(</span><span class="s2">&quot;Error convert it into a fixed length byte sequence&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.label_sample"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.label_sample">[docs]</a>    <span class="k">def</span> <span class="nf">label_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="s2">&quot;family&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate label for the loaded sample. You can use platform, cve, metatype, type, and family (default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">merged_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">external_labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vendor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">:</span>
                <span class="n">merged_labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">vendor</span><span class="p">][</span><span class="s2">&quot;normalized&quot;</span><span class="p">][</span><span class="n">label_type</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">external_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">merged_labels</span> <span class="o">=</span> <span class="n">external_labels</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">merged_labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
            <span class="k">return</span>

        <span class="c1"># Get most common label if it has more hits than set threshold</span>
        <span class="n">labels_frequency</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">merged_labels</span><span class="p">)</span>
        <span class="n">top_label</span><span class="p">,</span> <span class="n">top_label_count</span> <span class="o">=</span> <span class="n">labels_frequency</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">top_label_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LABEL_SIGNIFICANCE_COUNT</span><span class="p">:</span>
                <span class="c1"># self.positives &gt;= self.POSITIVE_RATE:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">top_label</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span></div>

<div class="viewcode-block" id="Instance.update"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert `element` at given `location`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element_to_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">location</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">etu</span> <span class="o">=</span> <span class="n">element_to_update</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">etu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">element_to_update</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">element_to_update</span> <span class="o">=</span> <span class="n">element_to_update</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_to_update</span> <span class="o">=</span> <span class="n">etu</span>
        <span class="n">element_to_update</span><span class="p">[</span><span class="n">location</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">element</span></div>

<div class="viewcode-block" id="Instance.save_json"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.save_json">[docs]</a>    <span class="k">def</span> <span class="nf">save_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save JSON stored in the class to a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">root_dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">j_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">,</span> <span class="n">j_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.extract_features"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.extract_features">[docs]</a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features of the loaded sample.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_features_static</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_features_dynamic</span><span class="p">()</span></div>

<div class="viewcode-block" id="Instance.extract_features_static"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.extract_features_static">[docs]</a>    <span class="k">def</span> <span class="nf">extract_features_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract static features of the loaded sample.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_static_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_static_signature</span><span class="p">()</span>
        <span class="c1"># self.feature_static_heuristic()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_static_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_static_packer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_static_pef</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_static_imports</span><span class="p">()</span></div>

<div class="viewcode-block" id="Instance.extract_features_dynamic"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.extract_features_dynamic">[docs]</a>    <span class="k">def</span> <span class="nf">extract_features_dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract dynamic features of the loaded sample.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dynamic_imports</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dynamic_filesystem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dynamic_network</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dynamic_registry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dynamic_windowsapi</span><span class="p">()</span></div>

<div class="viewcode-block" id="Instance.feature_static_metadata"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create features form extracted binary metadata.&quot;&quot;&quot;</span>
        
        <span class="c1"># Get binary size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">)</span>

        <span class="c1"># Get binary timestamp in the UNIX timestamp format</span>
        <span class="n">str_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_timestamp&quot;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">str_dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">str_dt</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>

        <span class="c1"># ExifTool output</span>
        <span class="n">et_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FileDescription&quot;</span><span class="p">,</span> <span class="s2">&quot;OriginalFilename&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">et_tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_versioninfo&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">et_tokens</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

        <span class="c1"># Magic byte</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;magic_byte&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.feature_static_signature"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_signature">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create features form binary signature check.&quot;&quot;&quot;</span>
        
        <span class="c1"># Check availability of digital signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;signed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;signature&quot;</span><span class="p">,</span> <span class="p">[]))</span>


        <span class="c1"># ExifTool output</span>
        <span class="n">et_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Comments&quot;</span><span class="p">,</span> <span class="s2">&quot;ProductName&quot;</span><span class="p">,</span> <span class="s2">&quot;LegalCopyright&quot;</span><span class="p">,</span> <span class="s2">&quot;InternalName&quot;</span><span class="p">,</span> <span class="s2">&quot;CompanyName&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">et_tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_versioninfo&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">et_tokens</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.feature_static_heuristic"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_heuristic">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create features form results return by heuristic tools.</span>
<span class="sd">        **Not available for current JSON content.**&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Instance.feature_static_packer"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_packer">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_packer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create feature from information returned by packer/cryptor detectors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peid_signatures&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.feature_static_pef"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_pef">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_pef</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create features from information derived form portable executable format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get resource languages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;languages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_resources&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lang</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lang</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;LANG_&quot;</span><span class="p">):</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;languages&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;languages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="n">sublang</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sublanguage&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sublang</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sublang</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SUBLANG_&quot;</span><span class="p">):</span>
                    <span class="n">sublang</span> <span class="o">=</span> <span class="n">sublang</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sublang</span> <span class="o">=</span> <span class="n">sublang</span>
                <span class="k">if</span> <span class="n">sublang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;languages&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;languages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sublang</span><span class="p">)</span>

        <span class="c1"># Section and resource attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;section_attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_sections&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entropy&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;section_attrs&quot;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;resource_attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_resources&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filetype&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;resource_attrs&quot;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Instance.feature_static_imports"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_imports">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features from static imports like referenced library</span>
<span class="sd">        functions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;static_imports&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Static libraries import count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;static_imports&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imported_dll_count&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Get all imported libraries</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pe_imports&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">ddl_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dll&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddl_name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;static_imports&quot;</span><span class="p">][</span><span class="n">ddl_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imports&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;static_imports&quot;</span><span class="p">][</span><span class="n">ddl_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span></div>

<div class="viewcode-block" id="Instance.feature_static_string"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_static_string">[docs]</a>    <span class="k">def</span> <span class="nf">feature_static_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create Static string list&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strings&quot;</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="Instance.feature_dynamic_imports"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_dynamic_imports">[docs]</a>    <span class="k">def</span> <span class="nf">feature_dynamic_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features from dynamic imports, mutexes, and processes.&quot;&quot;&quot;</span>
        <span class="c1"># Get mutexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;mutex&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mutex&quot;</span><span class="p">)</span>

        <span class="c1"># Get processes names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">p_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">and</span> <span class="n">p_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

        <span class="c1"># Get dynamically loaded library names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;dynamic_imports&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dll_loaded&quot;</span><span class="p">,</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="Instance.feature_dynamic_filesystem"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_dynamic_filesystem">[docs]</a>    <span class="k">def</span> <span class="nf">feature_dynamic_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features from filesystem operations.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">flatten_list</span><span class="p">(</span><span class="n">structured</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Flatten nested list.&quot;&quot;&quot;</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">structured</span><span class="p">:</span>
                <span class="n">flat</span> <span class="o">+=</span> <span class="n">i</span>
            <span class="k">return</span> <span class="n">flat</span>

        <span class="c1"># Get file operations and their number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_read&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_read&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_read&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_read&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_written&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_written&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_written&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_written&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_deleted&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_deleted&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_deleted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_deleted&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_copied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_copied&quot;</span><span class="p">,</span> <span class="p">[])</span>
                                                   <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_copied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_copied&quot;</span><span class="p">,</span> <span class="p">[])</span>
                                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_renamed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_moved&quot;</span><span class="p">,</span> <span class="p">[])</span>
                                                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_renamed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;file_renamed&quot;</span><span class="p">])</span>

        <span class="c1"># Get other file operations numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_opened&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_opened&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_exists&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_exists&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_failed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_failed&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>

        <span class="c1"># Get total number of unique touched files</span>
        <span class="n">file_operations</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_read&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_written&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_deleted&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
            <span class="n">flatten_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_copied&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">+</span> \
            <span class="n">flatten_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_moved&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_recreated&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_opened&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_exists&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_failed&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># remove duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;files_operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">file_operations</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Instance.feature_dynamic_network"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_dynamic_network">[docs]</a>    <span class="k">def</span> <span class="nf">feature_dynamic_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features from network operations.&quot;&quot;&quot;</span>
        <span class="c1"># Get TCP IP addresses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tcp&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">c_dst</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dst&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_dst</span> <span class="ow">and</span> <span class="n">c_dst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_dst</span><span class="p">)</span>

        <span class="c1"># Get UDP IPs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;udp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;udp&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">c_dst</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dst&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_dst</span> <span class="ow">and</span> <span class="n">c_dst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;udp&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;udp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_dst</span><span class="p">)</span>

        <span class="c1"># Get DNS queries and responses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dns&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">answers</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answers&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">:</span>
                <span class="n">a_type</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="n">a_data</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a_type</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span> <span class="ow">and</span> <span class="n">a_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;dns&quot;</span><span class="p">][</span><span class="n">request</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_data</span><span class="p">)</span>

        <span class="c1"># Get HTTP requests: method, host, port, path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">c_data</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">][</span><span class="n">c_data</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">c_method</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">][</span><span class="n">c_data</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_method</span>
            <span class="n">c_host</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_host</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">][</span><span class="n">c_data</span><span class="p">][</span><span class="s2">&quot;host&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_host</span>
            <span class="n">c_port</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_port</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">][</span><span class="n">c_data</span><span class="p">][</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_port</span></div>

<div class="viewcode-block" id="Instance.feature_dynamic_registry"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_dynamic_registry">[docs]</a>    <span class="k">def</span> <span class="nf">feature_dynamic_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features from registry operations.&quot;&quot;&quot;</span>
        <span class="c1"># Registry written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;regkey_written&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regkey_written&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Registry delete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;regkey_deleted&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>\
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regkey_deleted&quot;</span><span class="p">,</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="Instance.feature_dynamic_windowsapi"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.feature_dynamic_windowsapi">[docs]</a>    <span class="k">def</span> <span class="nf">feature_dynamic_windowsapi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features from Windows API calls sequence.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;api_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">apistats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;apistats&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">apistats</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">apistats</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;api_stats&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;api_stats&quot;</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">+=</span> <span class="n">apistats</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;api_stats&quot;</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">apistats</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">e</span><span class="p">]</span></div>

<div class="viewcode-block" id="Instance.extract_basic_features"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Instance.extract_basic_features">[docs]</a>    <span class="k">def</span> <span class="nf">extract_basic_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract very basic set of features from *signatures* JSON field.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_features</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;signatures&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basic_features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basic_features</span><span class="p">[</span><span class="nb">hash</span><span class="p">(</span><span class="n">description</span><span class="p">)]</span> <span class="o">=</span> <span class="n">description</span></div></div>

<div class="viewcode-block" id="Detection"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection">[docs]</a><span class="k">class</span> <span class="nc">Detection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base abstract class for detection module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># conf options</span>
        <span class="c1"># self.json_path = None  # 原文件结果路径</span>
        <span class="c1"># self.bin_path = None  # 原文件路径</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaries_location</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaries_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 保持模型预测结果</span>

<div class="viewcode-block" id="Detection.set_options"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.set_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set report options.</span>

<span class="sd">        :param options: report options dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Detection.set_path"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.set_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set paths.</span>

<span class="sd">        :param analysis_path: analysis folder path.</span>
<span class="sd">        :param file_path: binaries file path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">analysis_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Detection.set_task"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.set_task">[docs]</a>    <span class="k">def</span> <span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add task information.</span>
<span class="sd">        </span>
<span class="sd">        :param task: task dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Detection.load_instance"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.load_instance">[docs]</a>    <span class="k">def</span> <span class="nf">load_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the sample instance and load the dictionary</span>
<span class="sd">        </span>
<span class="sd">        :param results:  results dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1">#导入json</span></div>
        <span class="c1"># self.binaries.extract_features() #导入全体特征</span>
        <span class="c1"># self.binaries.extract_basic_features()</span>

<div class="viewcode-block" id="Detection.get_features"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.get_features">[docs]</a>    <span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return complex binary features as a labelled dictionary.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">:</span>
                <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">features</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">,</span> <span class="n">Instance</span><span class="p">):</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="o">.</span><span class="n">features</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown binary format</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Could not get the features *&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">,</span> <span class="s2">&quot;* is of &quot;</span> <span class="s2">&quot;unknown type: &quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">),</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">return</span> <span class="n">features</span></div>
    <span class="c1"># ------------------- only dir --------------------------</span>
<div class="viewcode-block" id="Detection.load_binaries_dir"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.load_binaries_dir">[docs]</a>    <span class="k">def</span> <span class="nf">load_binaries_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all binaries&#39; reports from given directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaries_location</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="c1"># 导入整个文件夹的json</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">label_sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">extract_features</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">extract_basic_features</span><span class="p">()</span></div>

<div class="viewcode-block" id="Detection.update_binaries"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.update_binaries">[docs]</a>    <span class="k">def</span> <span class="nf">update_binaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach &quot;elements&quot; to the loaded JSON at the given location&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries_updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">root</span> <span class="o">+</span> <span class="p">[</span><span class="n">locations</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries_updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">root</span> <span class="o">+</span> <span class="p">[</span><span class="n">locations</span><span class="p">])</span></div>

<div class="viewcode-block" id="Detection.save_binaries"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.save_binaries">[docs]</a>    <span class="k">def</span> <span class="nf">save_binaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alternative_location</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the binaries to given location if they have been updated.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries_updated</span><span class="p">:</span>
            <span class="n">save_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries_location</span>
            <span class="k">if</span> <span class="n">alternative_location</span><span class="p">:</span>
                <span class="n">save_location</span> <span class="o">=</span> <span class="n">alternative_location</span>
                <span class="k">if</span> <span class="n">save_location</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
                    <span class="n">save_location</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>

            <span class="c1"># Create directory if it does not exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_location</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binaries_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The binaries haven&#39;t been updated. No need to save them.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Detection.get_labels"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.get_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return binary labels as a labelled dictionary.&quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">label</span>
        <span class="k">return</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="Detection.get_simple_features"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.get_simple_features">[docs]</a>    <span class="k">def</span> <span class="nf">get_simple_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return simplified binary features as a labelled dictionary.&quot;&quot;&quot;</span>
        <span class="n">simple_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">:</span>
            <span class="n">simple_features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">basic_features</span>
        <span class="k">return</span> <span class="n">simple_features</span></div>
    <span class="c1"># ------------------- only dir --------------------------</span>
<div class="viewcode-block" id="Detection.run"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Detection.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start detection.</span>
<span class="sd">        </span>
<span class="sd">        :raise NotImplementedError: this method is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="Signature"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature">[docs]</a><span class="k">class</span> <span class="nc">Signature</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for Cuckoo signatures.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">families</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alert</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">minimum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Maximum amount of marks to record.</span>
    <span class="n">markcount</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># Basic filters to reduce the amount of events sent to this signature.</span>
    <span class="n">filter_apinames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filter_categories</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># If no on_call() handler is present and this field has been set, then</span>
    <span class="c1"># dispatch on a per-API basis to the accompanying API. That is, rather</span>
    <span class="c1"># than calling the generic on_call(), call, e.g., on_call_CreateFile().</span>
    <span class="n">on_call_dispatch</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caller</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param caller: calling object. Stores results in caller.results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caller</span> <span class="o">=</span> <span class="n">caller</span>

        <span class="c1"># These are set by the caller, they represent the process identifier</span>
        <span class="c1"># and call index respectively.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks a pattern against a given subject.</span>
<span class="sd">        </span>
<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param subject: target of the check.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">subject</span><span class="p">):</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subject</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

        <span class="c1"># Return all elements.</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="c1"># Return only the first element, if available. Otherwise return None.</span>
        <span class="k">elif</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<div class="viewcode-block" id="Signature.get_results"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get Signature results</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caller</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caller</span><span class="o">.</span><span class="n">results</span></div>

<div class="viewcode-block" id="Signature.get_processes"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_processes">[docs]</a>    <span class="k">def</span> <span class="nf">get_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of processes.</span>

<span class="sd">        :param name: If set only return processes with that name.</span>
<span class="sd">        :return: List of processes or empty list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Signature.get_process_by_pid"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_process_by_pid">[docs]</a>    <span class="k">def</span> <span class="nf">get_process_by_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a process by its process identifier.</span>

<span class="sd">        :param pid: pid to search for.</span>
<span class="sd">        :return: process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Signature.get_summary"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Get one or all values related to the global summary.&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="n">summary</span></div>

<div class="viewcode-block" id="Signature.get_summary_generic"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_summary_generic">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary_generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get generic info from summary.</span>

<span class="sd">        :param pid: pid of the process. None for all</span>
<span class="sd">        :param actions: A list of actions to get</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generic&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">process</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">process</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]:</span>
                    <span class="n">ret</span> <span class="o">+=</span> <span class="n">process</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="n">action</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Signature.get_files"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get files read, queried, or written to optionally by a</span>
<span class="sd">        specific process.</span>

<span class="sd">        :param pid: the process or None for all</span>
<span class="sd">        :param actions: actions to search for. None is all</span>
<span class="sd">        :return: yields files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;file_opened&quot;</span><span class="p">,</span> <span class="s2">&quot;file_written&quot;</span><span class="p">,</span>
                <span class="s2">&quot;file_read&quot;</span><span class="p">,</span> <span class="s2">&quot;file_deleted&quot;</span><span class="p">,</span>
                <span class="s2">&quot;file_exists&quot;</span><span class="p">,</span> <span class="s2">&quot;file_failed&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary_generic</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_dll_loaded"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_dll_loaded">[docs]</a>    <span class="k">def</span> <span class="nf">get_dll_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get DLLs loaded by a specific process.</span>

<span class="sd">        :param pid: the process or None for all</span>
<span class="sd">        :return: yields DLLs loaded</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary_generic</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dll_loaded&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Signature.get_keys"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get registry keys.</span>

<span class="sd">        :param pid: The pid to look in or None for all.</span>
<span class="sd">        :param actions: the actions as a list.</span>
<span class="sd">        :return: yields registry keys</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;regkey_opened&quot;</span><span class="p">,</span> <span class="s2">&quot;regkey_written&quot;</span><span class="p">,</span>
                <span class="s2">&quot;regkey_read&quot;</span><span class="p">,</span> <span class="s2">&quot;regkey_deleted&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary_generic</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.check_file"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_file">[docs]</a>    <span class="k">def</span> <span class="nf">check_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for a file being opened.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :param actions: a list of key actions to use.</span>
<span class="sd">        :param pid: The process id to check. If it is set to None, all</span>
<span class="sd">                    processes will be checked.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;file_opened&quot;</span><span class="p">,</span> <span class="s2">&quot;file_written&quot;</span><span class="p">,</span>
                <span class="s2">&quot;file_read&quot;</span><span class="p">,</span> <span class="s2">&quot;file_deleted&quot;</span><span class="p">,</span>
                <span class="s2">&quot;file_exists&quot;</span><span class="p">,</span> <span class="s2">&quot;file_failed&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">actions</span><span class="p">),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.check_dll_loaded"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_dll_loaded">[docs]</a>    <span class="k">def</span> <span class="nf">check_dll_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for DLLs being loaded.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :param pid: The process id to check. If it is set to None, all</span>
<span class="sd">                    processes will be checked.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dll_loaded</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.check_key"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_key">[docs]</a>    <span class="k">def</span> <span class="nf">check_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for a registry key being accessed.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :param actions: a list of key actions to use.</span>
<span class="sd">        :param pid: The process id to check. If it is set to None, all</span>
<span class="sd">                    processes will be checked.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;regkey_written&quot;</span><span class="p">,</span> <span class="s2">&quot;regkey_opened&quot;</span><span class="p">,</span>
                <span class="s2">&quot;regkey_read&quot;</span><span class="p">,</span> <span class="s2">&quot;regkey_deleted&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">actions</span><span class="p">),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_mutexes"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_mutexes">[docs]</a>    <span class="k">def</span> <span class="nf">get_mutexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the summary genertic</span>

<span class="sd">        :param pid: Pid to filter for</span>
<span class="sd">        :return:List of mutexes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary_generic</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mutex&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Signature.check_mutex"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_mutex">[docs]</a>    <span class="k">def</span> <span class="nf">check_mutex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for a mutex being opened.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mutexes</span><span class="p">(),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_command_lines"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_command_lines">[docs]</a>    <span class="k">def</span> <span class="nf">get_command_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves all command lines used.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary</span><span class="p">(</span><span class="s2">&quot;command_line&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_wmi_queries"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_wmi_queries">[docs]</a>    <span class="k">def</span> <span class="nf">get_wmi_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves all executed WMI queries.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary</span><span class="p">(</span><span class="s2">&quot;wmi_query&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_generic"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_generic">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic getting network data.</span>

<span class="sd">        :param subtype: subtype string to search for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="Signature.get_net_hosts"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all hosts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;hosts&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_domains"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_domains">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_domains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all domains.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_http"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_http">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_http</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all http data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_http_ex"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_http_ex">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_http_ex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all http data.&quot;&quot;&quot;</span>
        <span class="k">return</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;http_ex&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;https_ex&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_udp"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_udp">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_udp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all udp data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;udp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_icmp"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_icmp">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_icmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all icmp data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;icmp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_irc"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_irc">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_irc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all irc data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;irc&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_net_smtp"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_net_smtp">[docs]</a>    <span class="k">def</span> <span class="nf">get_net_smtp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all smtp data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_generic</span><span class="p">(</span><span class="s2">&quot;smtp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_virustotal"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_virustotal">[docs]</a>    <span class="k">def</span> <span class="nf">get_virustotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the information retrieved from virustotal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;virustotal&quot;</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="Signature.get_volatility"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_volatility">[docs]</a>    <span class="k">def</span> <span class="nf">get_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the data that belongs to the given module.&quot;&quot;&quot;</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">volatility</span> <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">volatility</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="Signature.get_apkinfo"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_apkinfo">[docs]</a>    <span class="k">def</span> <span class="nf">get_apkinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Returns the apkinfo results for this analysis.&quot;&quot;&quot;</span>
        <span class="n">apkinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;apkinfo&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">apkinfo</span> <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">apkinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_droidmon"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_droidmon">[docs]</a>    <span class="k">def</span> <span class="nf">get_droidmon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Returns the droidmon results for this analysis.&quot;&quot;&quot;</span>
        <span class="n">droidmon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;droidmon&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">droidmon</span> <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">droidmon</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.get_googleplay"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.get_googleplay">[docs]</a>    <span class="k">def</span> <span class="nf">get_googleplay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Returns the Google Play results for this analysis.&quot;&quot;&quot;</span>
        <span class="n">googleplay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="s2">&quot;googleplay&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">googleplay</span> <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">googleplay</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.check_ip"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_ip">[docs]</a>    <span class="k">def</span> <span class="nf">check_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for an IP address being contacted.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_net_hosts</span><span class="p">(),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.check_domain"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_domain">[docs]</a>    <span class="k">def</span> <span class="nf">check_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for a domain being contacted.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_domains</span><span class="p">():</span>
            <span class="n">domains</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">domains</span><span class="p">),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.check_url"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.check_url">[docs]</a>    <span class="k">def</span> <span class="nf">check_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for a URL being contacted.</span>

<span class="sd">        :param pattern: string or expression to check for.</span>
<span class="sd">        :param regex: boolean representing if the pattern is a regular</span>
<span class="sd">                      expression or not and therefore should be compiled.</span>
<span class="sd">        :return: boolean with the result of the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_http</span><span class="p">():</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_value</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                 <span class="n">subject</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">urls</span><span class="p">),</span>
                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                 <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.init"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow signatures to initialize themselves.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Signature.mark_call"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.mark_call">[docs]</a>    <span class="k">def</span> <span class="nf">mark_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the current call as explanation as to why this signature</span>
<span class="sd">        matched.&quot;&quot;&quot;</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;cid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span>
            <span class="s2">&quot;call&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;You have provided extra arguments to the mark_call() method &quot;</span>
                <span class="s2">&quot;which no longer supports doing so. Please report explicit &quot;</span>
                <span class="s2">&quot;IOCs through mark_ioc().&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.mark_ioc"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.mark_ioc">[docs]</a>    <span class="k">def</span> <span class="nf">mark_ioc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark an IOC as explanation as to why the current signature</span>
<span class="sd">        matched.&quot;&quot;&quot;</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ioc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
            <span class="s2">&quot;ioc&quot;</span><span class="p">:</span> <span class="n">ioc</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Prevent duplicates.</span>
        <span class="k">if</span> <span class="n">mark</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.mark_vol"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.mark_vol">[docs]</a>    <span class="k">def</span> <span class="nf">mark_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark output of a Volatility plugin as explanation as to why the</span>
<span class="sd">        current signature matched.&quot;&quot;&quot;</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;volatility&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plugin&quot;</span><span class="p">:</span> <span class="n">plugin</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mark</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.mark"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.mark">[docs]</a>    <span class="k">def</span> <span class="nf">mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark arbitrary data.&quot;&quot;&quot;</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;generic&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mark</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signature.has_marks"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.has_marks">[docs]</a>    <span class="k">def</span> <span class="nf">has_marks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if this signature has one or more marks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">marks</span></div>

<div class="viewcode-block" id="Signature.on_call"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.on_call">[docs]</a>    <span class="k">def</span> <span class="nf">on_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Notify signature about API call. Return value determines</span>
<span class="sd">        if this signature is done or could still match.</span>

<span class="sd">        Only called if signature is &quot;active&quot;.</span>

<span class="sd">        :param call: logged API call.</span>
<span class="sd">        :param process: proc object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Dispatch this call to a per-API specific handler.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_call_dispatch</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;on_call_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;api&quot;</span><span class="p">])(</span><span class="n">call</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Signature.on_signature"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.on_signature">[docs]</a>    <span class="k">def</span> <span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Event yielded when another signatures has matched. Some signatures</span>
<span class="sd">        only take effect when one or more other signatures have matched as</span>
<span class="sd">        well.</span>

<span class="sd">        :param signature: The signature that just matched</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Signature.on_process"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.on_process">[docs]</a>    <span class="k">def</span> <span class="nf">on_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called on process change.</span>

<span class="sd">        :note: Can be used for cleanup of flags, re-activation of the signature, etc.</span>
<span class="sd">        :param process: dictionary describing this process</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Signature.on_complete"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.on_complete">[docs]</a>    <span class="k">def</span> <span class="nf">on_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signature is notified when all API calls have been processed.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Signature.results"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Signature.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn this signature into actionable results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span>
                    <span class="n">families</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">families</span><span class="p">,</span>
                    <span class="n">references</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">,</span>
                    <span class="n">marks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">markcount</span><span class="p">],</span>
                    <span class="n">markcount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="Report"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Report">[docs]</a><span class="k">class</span> <span class="nc">Report</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base abstract class for reporting module.&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_analysis_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="n">subpath</span><span class="p">)</span>

<div class="viewcode-block" id="Report.set_path"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Report.set_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set analysis folder path.</span>

<span class="sd">        :param analysis_path: analysis folder path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">analysis_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_analysis_path</span><span class="p">(</span><span class="s2">&quot;analysis.conf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_analysis_path</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_analysis_path</span><span class="p">(</span><span class="s2">&quot;reports&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shots_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_analysis_path</span><span class="p">(</span><span class="s2">&quot;shots&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pcap_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_analysis_path</span><span class="p">(</span><span class="s2">&quot;dump.pcap&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">create_folder</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CuckooOperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CuckooReportError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Report.set_options"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Report.set_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set report options.</span>

<span class="sd">        :param options: report options dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Report.set_task"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Report.set_task">[docs]</a>    <span class="k">def</span> <span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add task information.</span>

<span class="sd">        :param task: task dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Report.run"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.Report.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start report processing.</span>

<span class="sd">        :raise NotImplementedError: this method is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="BehaviorHandler"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.BehaviorHandler">[docs]</a><span class="k">class</span> <span class="nc">BehaviorHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for behavior handlers inside of BehaviorAnalysis.&quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;undefined&quot;</span>

    <span class="c1"># Behavior event types this handler is interested in.</span>
    <span class="n">event_types</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behavior_analysis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span> <span class="o">=</span> <span class="n">behavior_analysis</span>

<div class="viewcode-block" id="BehaviorHandler.handles_path"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.BehaviorHandler.handles_path">[docs]</a>    <span class="k">def</span> <span class="nf">handles_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Needs to return True for the log files this handler wants to</span>
<span class="sd">        process.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BehaviorHandler.parse"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.BehaviorHandler.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after handles_path succeeded, should generate behavior</span>
<span class="sd">        events.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="BehaviorHandler.handle_event"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.BehaviorHandler.handle_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an event that gets passed down the stack.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="BehaviorHandler.run"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.BehaviorHandler.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the handler specific structure, gets placed into</span>
<span class="sd">        behavior[self.key].&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="ProtocolHandler"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.ProtocolHandler">[docs]</a><span class="k">class</span> <span class="nc">ProtocolHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract class for protocol handlers coming out of the analysis.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

<div class="viewcode-block" id="ProtocolHandler.init"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.ProtocolHandler.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ProtocolHandler.close"><a class="viewcode-back" href="../../../../lib.cuckoo.common.html#lib.cuckoo.common.abstracts.ProtocolHandler.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, PowerLZY.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>